name: CI/CD (git-pull deploy to EC2)

on:
  push:
    branches: [dev]
  pull_request:
    branches: [dev]
  workflow_dispatch: {}

jobs:
  build:
    name: Build check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install backend dependencies
        working-directory: ./backend
        run: |
          npm ci --prefer-offline --no-audit --progress=false

      - name: Build backend (typecheck + compile)
        working-directory: ./backend
        run: |
          npm run build --if-present

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: |
          npm ci --prefer-offline --no-audit --progress=false

      - name: Build frontend
        working-directory: ./frontend
        run: |
          npm run build --if-present

  deploy:
    name: Deploy to EC2 (git-pull & docker compose)
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Prepare .env artifact (runner)
        run: |
          set -euo pipefail
          # Create a deploy_env file in the runner workspace with required secrets
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" > deploy_env
          echo "MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}" >> deploy_env
          echo "MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}" >> deploy_env
          echo "NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}" >> deploy_env

      - name: Prepare deploy SSH key (decode)
        env:
          DEPLOY_KEY_B64: ${{ secrets.DEPLOY_KEY_B64 }}
        run: |
          set -euo pipefail
          echo "Decoding deploy key into /tmp/deploy_ssh_key"
          echo "$DEPLOY_KEY_B64" | base64 --decode > /tmp/deploy_ssh_key
          chmod 600 /tmp/deploy_ssh_key

      - name: Upload .env to server (scp)
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          set -euo pipefail
          TARGET_DIR="/home/${EC2_USER}/codeverse"
          ssh -o StrictHostKeyChecking=no -i /tmp/deploy_ssh_key ${EC2_USER}@${EC2_HOST} "mkdir -p '${TARGET_DIR}'"
          scp -o StrictHostKeyChecking=no -i /tmp/deploy_ssh_key deploy_env ${EC2_USER}@${EC2_HOST}:"${TARGET_DIR}/.env"
          ssh -o StrictHostKeyChecking=no -i /tmp/deploy_ssh_key ${EC2_USER}@${EC2_HOST} "chmod 600 '${TARGET_DIR}/.env' && chown ${EC2_USER}:${EC2_USER} '${TARGET_DIR}/.env' || true"

      - name: Ensure remote deploy dir exists
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          set -euo pipefail
          ssh -o StrictHostKeyChecking=no -i /tmp/deploy_ssh_key ${EC2_USER}@${EC2_HOST} "mkdir -p ${DEPLOY_PATH:-~/deploy}"

      - name: Remote git pull + compose deploy
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          ssh -o StrictHostKeyChecking=no -i /tmp/deploy_ssh_key ${EC2_USER}@${EC2_HOST} 'bash -s' <<'REMOTE'
            set -euo pipefail
            DEPLOY_DIR="${DEPLOY_PATH:-/home/${EC2_USER}/deploy}"
            echo "Using deploy dir: $DEPLOY_DIR"
            mkdir -p "$DEPLOY_DIR"

            if [ -d "/home/${EC2_USER}/codeverse/.git" ]; then
              REPO_PATH="/home/${EC2_USER}/codeverse"
            else
              REPO_PATH="$DEPLOY_DIR/codeverse"
            fi

            echo "Repository path: $REPO_PATH"
            echo "DEBUG: DEPLOY_DIR=$DEPLOY_DIR"
            echo "DEBUG: REPO_PATH=$REPO_PATH"

            if [ -d "$REPO_PATH/.git" ]; then
              cd "$REPO_PATH"
              git fetch --all --prune
              git reset --hard origin/${GITHUB_REF_NAME:-dev} || git reset --hard origin/dev
            else
              mkdir -p "$(dirname "$REPO_PATH")"
              git clone https://github.com/kt-codeverse/codeverse.git "$REPO_PATH"
              cd "$REPO_PATH"
              git checkout -f ${GITHUB_REF_NAME:-dev} || git checkout -f dev
            fi

            if [ ! -f .env ]; then
              echo "ERROR: .env not found in $PWD. Create .env with MYSQL_ROOT_PASSWORD and DATABASE_URL before running automatic deploy." >&2
              ls -la
              exit 2
            fi

            echo "--- remote deploy files ---"
            ls -la | sed -n '1,200p'
            echo "--- .env (masked) ---"
            sed -n '1,50p' .env | sed -E 's/(MYSQL_ROOT_PASSWORD=).*/\1***MASKED***/; s#(DATABASE_URL=)(mysql://root:)[^@]+@#\1\2***@#' || true

            docker compose --version || true
            docker compose --env-file .env -f docker-compose.yml pull || true
            docker compose --env-file .env -f docker-compose.yml up -d --build --remove-orphans

            echo "Running Prisma migrations (if available) (inside service)"
            if docker compose --env-file .env -f docker-compose.yml run --rm backend npx prisma migrate deploy; then
              echo "migrations applied inside service"
            else
              echo "migrate deploy inside service failed or schema missing â€” attempting fallback using ephemeral node container"
              docker run --rm \
                --network codeverse_default \
                --env-file "$REPO_PATH/.env" \
                -v "$REPO_PATH":/workspace \
                -w /workspace/backend \
                node:20 \
                sh -c "npm ci --prefer-offline --no-audit --progress=false && npx prisma migrate deploy" || echo "fallback migrate also failed"
            fi

            docker compose --env-file .env -f docker-compose.yml ps

            TIMESTAMP="$(date -u '+%Y-%m-%dT%H:%M:%SZ')"
            COMMIT_SHORT="$(cd "$REPO_PATH" 2>/dev/null && git rev-parse --short HEAD || echo unknown)"

            if [ -d "$REPO_PATH" ]; then
              echo "$COMMIT_SHORT $TIMESTAMP deployed" > "$REPO_PATH/.deploy_success" || true
              chmod 644 "$REPO_PATH/.deploy_success" || true
              echo "WROTE: $REPO_PATH/.deploy_success"
            fi
          REMOTE

      - name: Create runner-side deploy marker and scp to EC2 (reliable fallback)
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          COMMIT_SHORT: ${{ github.sha }}
        run: |
          set -euo pipefail
          TIMESTAMP="$(date -u '+%Y-%m-%dT%H:%M:%SZ')"
          echo "$COMMIT_SHORT $TIMESTAMP deployed" > deploy_marker

          TARGET_DIR="/home/${EC2_USER}/codeverse"
          ssh -o StrictHostKeyChecking=no -i /tmp/deploy_ssh_key ${EC2_USER}@${EC2_HOST} "mkdir -p '${TARGET_DIR}'"
          scp -o StrictHostKeyChecking=no -i /tmp/deploy_ssh_key deploy_marker ${EC2_USER}@${EC2_HOST}:"${TARGET_DIR}/.deploy_success" || echo "scp to EC2 failed"
          ssh -o StrictHostKeyChecking=no -i /tmp/deploy_ssh_key ${EC2_USER}@${EC2_HOST} "chmod 644 '${TARGET_DIR}/.deploy_success' || true"

          rm -f deploy_marker || true
