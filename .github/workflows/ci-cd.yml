name: CI/CD (Docker Hub + EC2 Deploy)

on:
  push:
    branches: [dev]

env:
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Backend 이미지 빌드 & Push
      - name: Build & push backend image
        run: |
          IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/TripNest-backend:${IMAGE_TAG}
          IMAGE_LATEST=${{ secrets.DOCKERHUB_USERNAME }}/TripNest-backend:latest
          docker build -t "$IMAGE" -f backend/Dockerfile backend
          docker tag "$IMAGE" "$IMAGE_LATEST"
          docker push "$IMAGE"
          docker push "$IMAGE_LATEST"

      # Frontend 이미지 빌드 & Push
      - name: Build & push frontend image
        run: |
          IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/TripNest-frontend:${IMAGE_TAG}
          IMAGE_LATEST=${{ secrets.DOCKERHUB_USERNAME }}/TripNest-frontend:latest
          docker build -t "$IMAGE" -f frontend/Dockerfile frontend
          docker tag "$IMAGE" "$IMAGE_LATEST"
          docker push "$IMAGE"
          docker push "$IMAGE_LATEST"

      # docker-compose.prod.yml → EC2 전송
      - name: Copy compose file to EC2
        uses: appleboy/scp-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          source: "docker-compose.prod.yml"
          target: "~/deploy"

      # EC2에서 Pull & Run
      - name: Deploy on EC2
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            cd ~/deploy

            # 이미지 설정
            IMAGE_PREFIX=${{ secrets.DOCKERHUB_USERNAME }}

            echo "BACKEND_IMAGE=$IMAGE_PREFIX/TripNest-backend:${IMAGE_TAG}" > .env
            echo "FRONTEND_IMAGE=$IMAGE_PREFIX/TripNest-frontend:${IMAGE_TAG}" >> .env
            echo "MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}" >> .env
            echo "MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}" >> .env
            echo "MYSQL_USER=${{ secrets.MYSQL_USER }}" >> .env
            echo "MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}" >> .env
            echo "NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}" >> .env

            # Docker Hub 로그인
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

            # Compose 실행
            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml up -d --force-recreate --remove-orphans
