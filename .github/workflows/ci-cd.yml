name: CI/CD (git-pull deploy to EC2)

on:
  push:
    branches: [ dev ]

jobs:
  build:
    name: Build check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install backend dependencies
        working-directory: ./backend
        run: |
          npm ci --prefer-offline --no-audit --progress=false

      - name: Build backend (typecheck + compile)
        working-directory: ./backend
        run: |
          npm run build --if-present

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: |
          npm ci --prefer-offline --no-audit --progress=false

      - name: Build frontend
        working-directory: ./frontend
        run: |
          npm run build --if-present

  deploy:
    name: Deploy to EC2 (git-pull & docker compose)
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Ensure remote deploy dir exists
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            mkdir -p ${DEPLOY_PATH:-~/deploy}

      - name: Remote git pull + compose deploy
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail
            DEPLOY_DIR="${DEPLOY_PATH:-/home/${{ secrets.EC2_USER }}/deploy}"
            echo "Using deploy dir: $DEPLOY_DIR"
            mkdir -p "$DEPLOY_DIR"
            cd "$DEPLOY_DIR"

            if [ -d codeverse/.git ]; then
              cd codeverse
              git fetch --all --prune
              git reset --hard origin/${{ github.ref_name }} || git reset --hard origin/dev
            else
              git clone https://github.com/kt-codeverse/codeverse.git
              cd codeverse
              git checkout -f ${GITHUB_REF_NAME:-dev} || git checkout -f dev
            fi

            # Basic checks for .env
            if [ ! -f .env ]; then
              echo "ERROR: .env not found in $PWD. Create .env with MYSQL_ROOT_PASSWORD and DATABASE_URL before running automatic deploy." >&2
              ls -la
              exit 2
            fi

            # Debug: list files and show masked .env header
            echo "--- remote deploy files ---"
            ls -la | sed -n '1,200p'
            echo "--- .env (masked) ---"
            sed -n '1,50p' .env | sed -E 's/(MYSQL_ROOT_PASSWORD=).*/\1***MASKED***/; s#(DATABASE_URL=)(mysql://root:)[^@]+@#\1\2***@#' || true

            # Ensure docker compose is available (uses docker compose plugin)
            docker compose --version || true

            # Pull latest images if using image-based deploy; if using repo build this will rebuild
            docker compose --env-file .env -f docker-compose.yml pull || true
            docker compose --env-file .env -f docker-compose.yml up -d --build --remove-orphans

            # Run Prisma migrations (if any) on the backend service
            echo "Running Prisma migrations (if available)"
            docker compose --env-file .env -f docker-compose.yml run --rm backend npx prisma migrate deploy || echo "migrate deploy failed or no migrations"

            # Show status
            docker compose --env-file .env -f docker-compose.yml ps
