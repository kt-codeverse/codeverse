name: CI/CD (Docker Hub + EC2 Deploy)

on:
  push:
    branches: [dev]

env:
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Backend 이미지 빌드 & Push
      - name: Build & push backend image
        run: |
          IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/TripNest-backend:${IMAGE_TAG}
          IMAGE_LATEST=${{ secrets.DOCKERHUB_USERNAME }}/TripNest-backend:latest
          docker build -t "$IMAGE" -f backend/Dockerfile backend
          docker tag "$IMAGE" "$IMAGE_LATEST"
          docker push "$IMAGE"
          docker push "$IMAGE_LATEST"

      # Frontend 이미지 빌드 & Push
      - name: Build & push frontend image
        run: |
          IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/TripNest-frontend:${IMAGE_TAG}
          IMAGE_LATEST=${{ secrets.DOCKERHUB_USERNAME }}/TripNest-frontend:latest
          docker build -t "$IMAGE" -f frontend/Dockerfile frontend
          docker tag "$IMAGE" "$IMAGE_LATEST"
          docker push "$IMAGE"
          docker push "$IMAGE_LATEST"

      # Prepare deploy package (contains docker-compose.prod.yml + .env)
      - name: Prepare deploy package
        run: |
          mkdir -p deploy_package
          cat > deploy_package/.env <<EOF
BACKEND_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/TripNest-backend:${IMAGE_TAG}
FRONTEND_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/TripNest-frontend:${IMAGE_TAG}
MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}
NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
EOF
          cp docker-compose.prod.yml deploy_package/

      - name: Copy deploy package to EC2
        uses: appleboy/scp-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          source: "deploy_package/*"
          target: "~/deploy"

      - name: Deploy on EC2
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -euo pipefail
            cd ~/deploy || exit 2
            echo "Files in ~/deploy:"; ls -la || true

            if [ ! -f .env ]; then
              echo ".env not found in ~/deploy - aborting"
              exit 3
            fi

            # Login to Docker Hub on remote host (do not echo token)
            echo "Logging into Docker Hub..."
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

            # Pull images (best-effort) and start services
            docker compose -f docker-compose.prod.yml pull || true
            docker compose -f docker-compose.prod.yml up -d --force-recreate --remove-orphans
            echo "Deploy finished"
